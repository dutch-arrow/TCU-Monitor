{"ast":null,"code":"import \"core-js/modules/es.array.push.js\";\nimport 'chartjs-adapter-moment';\nimport { Chart as ChartJS, CategoryScale, LinearScale, PointElement, LineElement, Title, Tooltip, Legend, TimeScale } from 'chart.js';\nimport { Line } from 'vue-chartjs';\nChartJS.register(CategoryScale, LinearScale, PointElement, LineElement, Title, Tooltip, Legend, TimeScale);\nexport default {\n  components: {\n    Line\n  },\n  name: 'HomePage',\n  props: ['showPage'],\n  data() {\n    return {\n      loading: false,\n      errmsg: '',\n      retrieveResult: '',\n      showDay: false,\n      showGraph: false,\n      tcu: {\n        name: '',\n        ipaddress: ''\n      },\n      devices: [],\n      search: '',\n      fileNames: [],\n      day: '',\n      loaded: false,\n      starttime: 0,\n      stoptime: 0,\n      graphHeight: 1.0,\n      graphSpace: 0.3,\n      devColors: ['#332655', '#490099', '#5d00d9', '#6d00ff', '#8557ff', '#ffa79c', '#055636', '#699986', '#9bc173', '#ee9a00', '#f86051', '#00cc1a'],\n      tempData: {\n        labels: [],\n        datasets: [{\n          label: '',\n          borderColor: '#f87979',\n          data: []\n        }]\n      },\n      chartOptions: {\n        responsive: true,\n        maintainAspectRatio: false,\n        plugins: {\n          legend: {\n            display: true\n          },\n          tooltip: {\n            callbacks: {\n              label: function (context) {\n                let label = context.dataset.label || '';\n                if (label) {\n                  label += ': ';\n                }\n                if (context.parsed.y !== null) {\n                  if (context.datasetIndex === 0) {\n                    // Temperature\n                    label += context.parsed.y * 20 + 15;\n                  } else {\n                    label += context.parsed.y / (1.0 + 0.3) - context.datasetIndex > 0.0 ? 'on' : 'off';\n                    let bytext = context.dataset.data[context.dataIndex].by;\n                    if (bytext.length > 0) {\n                      label += ' by: ' + context.dataset.data[context.dataIndex].by;\n                    }\n                  }\n                }\n                return label;\n              }\n            }\n          }\n        },\n        scales: {\n          y: {\n            type: 'linear',\n            ticks: {\n              callback: function () {\n                return '';\n              }\n            },\n            grid: {\n              display: false\n            }\n          },\n          x: {\n            type: 'time',\n            time: {\n              unit: 'hour',\n              displayFormats: {\n                hour: 'HH:mm'\n              },\n              tooltipFormat: 'HH:mm',\n              ticks: {\n                source: 'auto'\n              }\n            },\n            min: this.starttime,\n            max: this.starttime + 1440000000\n          }\n        },\n        elements: {\n          point: {\n            pointStyle: false\n          },\n          line: {\n            borderWidth: 1\n          }\n        }\n      }\n    };\n  },\n  computed: {\n    chartHeight() {\n      return {\n        height: `${500}px`,\n        position: 'relative'\n      };\n    }\n  },\n  methods: {\n    getProperties() {\n      this.loading = true;\n      this.axios.post(\"/api/command\", {\n        command: \"getProperties\",\n        data: {\n          ipaddress: this.tcu.ipaddress\n        }\n      }).then(response => {\n        var f = response.data;\n        if (f.error !== undefined) {\n          this.errmsg = \"danger\";\n          this.retrieveResult = f.error;\n        } else {\n          this.devices = [];\n          for (var dev of f.devices) {\n            this.devices.push(dev.device);\n          }\n        }\n        this.loading = false;\n      }).catch(error => {\n        this.retrieveResult = error.message;\n        this.errmsg = \"danger\";\n        this.loading = false;\n      });\n    },\n    getHistDataFiles() {\n      this.loading = true;\n      this.axios.post(\"/api/command\", {\n        command: \"getHistDataFiles\",\n        data: {\n          ipaddress: this.tcu.ipaddress\n        }\n      }).then(response => {\n        var f = response.data;\n        if (f.error !== undefined) {\n          this.errmsg = \"danger\";\n          this.retrieveResult = f.error;\n        } else {\n          this.fileNames = [];\n          for (var nm of f.files) {\n            this.fileNames.push(String(nm).replace(\"temp_\", \"\"));\n          }\n        }\n        this.loading = false;\n      }).catch(error => {\n        this.retrieveResult = error.message;\n        this.errmsg = \"danger\";\n        this.loading = false;\n      });\n    },\n    getTempDataFile(day) {\n      this.loaded = false;\n      this.loading = true;\n      this.axios.post(\"/api/command\", {\n        command: \"getTempDataFile\",\n        data: {\n          ipaddress: this.tcu.ipaddress,\n          file: 'temp_' + day\n        }\n      }).then(response => {\n        var f = response.data;\n        if (f.error !== undefined) {\n          this.errmsg = \"danger\";\n          this.retrieveResult = f.error;\n        } else {\n          this.errmsg = \"success\";\n          this.retrieveResult = \"\";\n          this.cvtTempData(f.content);\n          this.getStateDataFile(day);\n        }\n        this.loading = false;\n      }).catch(error => {\n        this.retrieveResult = error.message;\n        this.errmsg = \"danger\";\n        this.loading = false;\n      });\n    },\n    cvtTempData(raw) {\n      /*\n      2023-07-05 14:00:00 start\n      2023-07-05 14:00:02 r=0 t=0\n      ...\n      2023-07-06 13:59:03 r=0 t=0\n      2023-07-06 14:00:03 r=0 t=0\n      2023-07-06 14:00:02 stop\n      */\n      this.tempData.datasets = [];\n      this.tempData.datasets.push({\n        label: 'Temperature',\n        borderColor: '#f87979',\n        data: []\n      });\n      var lines = String(raw).split(\"\\n\");\n      for (var l of lines) {\n        var parts = String(l).split(\" \");\n        if (parts.length === 3) {\n          if (parts[2] === \"start\") {\n            this.starttime = this.getMinutes(parts[0] + \"T\" + parts[1]);\n          } else {\n            this.stoptime = this.getMinutes(parts[0] + \"T\" + parts[1]);\n          }\n        } else if (parts.length > 3) {\n          var temp = Number(String(parts[3]).split(\"=\")[1]); // terrarium temperature\n          if (temp === 0) temp = 26.0;\n          temp = (temp - 15.0) * this.graphHeight / (35.0 - 15.0);\n          var time = this.getMinutes(parts[0] + \"T\" + parts[1]);\n          this.tempData.datasets[0].data.push({\n            x: time,\n            y: temp\n          });\n        }\n      }\n    },\n    getStateDataFile(day) {\n      this.loading = true;\n      this.axios.post(\"/api/command\", {\n        command: \"getStateDataFile\",\n        data: {\n          ipaddress: this.tcu.ipaddress,\n          file: 'state_' + day\n        }\n      }).then(response => {\n        var f = response.data;\n        if (f.error !== undefined) {\n          this.errmsg = \"danger\";\n          this.retrieveResult = f.error;\n        } else {\n          this.errmsg = \"success\";\n          this.retrieveResult = \"\";\n          this.cvtStateData(f.content);\n        }\n        this.loading = false;\n      }).catch(error => {\n        this.retrieveResult = error.message;\n        this.errmsg = \"danger\";\n        this.loading = false;\n      });\n    },\n    cvtStateData(raw) {\n      /*\n      date       time     device endtime controlled by (0: free, 1-5: temp rule, -1: sprayer rule, -2: mist rule, -3: timer)\n      ------------------------------\n      2023-08-01 00:00:00 light6 1 4\n      2023-08-01 00:00:00 pump 0 4\n      2023-08-01 00:00:00 sprayer 0 4\n      2023-08-01 00:00:00 mist 0 4\n      2023-08-01 00:00:00 fan_in 0 4\n      2023-08-01 00:00:00 fan_out 0 4\n      2023-08-01 00:00:00 spare 0 4\n      2023-08-01 06:00:02 mist 1 -1 -3\n      2023-08-01 06:00:02 fan_in 0 -2\n      2023-08-01 06:00:02 fan_out 0 -2\n      2023-08-01 06:45:02 mist 0 0\n      2023-08-01 06:45:02 fan_in 0 0\n      2023-08-01 06:45:02 fan_out 0 0\n      2023-08-01 09:00:02 light1 1 -1 -3\n      2023-08-01 09:00:02 light6 0 0\n      2023-08-01 09:30:02 light2 1 -1 -3\n      2023-08-01 10:00:02 light3 1 -1 -3\n      2023-08-01 10:05:02 sprayer 1 10:05:32 -3\n      2023-08-01 10:05:02 fan_in 0 -1\n      2023-08-01 10:05:02 fan_out 0 -1\n      2023-08-01 10:05:32 sprayer 0 0\n      2023-08-01 10:15:02 light4 1 -1 -3\n      2023-08-01 10:20:02 fan_in 1 10:35:02 -1\n      2023-08-01 10:20:02 fan_out 1 10:35:02 -1\n      2023-08-01 10:35:02 fan_in 0 0\n      2023-08-01 10:35:02 fan_out 0 0\n      2023-08-01 10:37:02 fan_in 1 -2 5\n      */\n      this.loaded = false;\n      for (var i = 1; i <= this.devices.length; i++) {\n        this.tempData.datasets.push({\n          label: this.devices[i - 1],\n          borderColor: this.devColors[i - 1],\n          data: Array(1441)\n        });\n      }\n      var prevdix = [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0];\n      var lines = String(raw).split(\"\\n\");\n      for (var l of lines) {\n        var parts = String(l).split(\" \");\n        if (parts.length > 3) {\n          var ix = this.getDeviceIndex(parts[2]) + 1;\n          if (ix !== 0) {\n            var time = this.getMinutes(parts[0] + \"T\" + parts[1]); // in milliseconds\n            var value = ix * (this.graphHeight + this.graphSpace) + Number(parts[3]) * this.graphHeight; // 0.0 => 2.0\n            var dix = this.getTimeIndex(this.starttime, parts[0] + \"T\" + parts[1]);\n            if (prevdix[ix] === dix) {\n              dix += 1; // on and off within a minute, then do the off one minute later\n            }\n\n            prevdix[ix] = dix;\n            console.log(\"Device=\" + parts[2] + \" time=\" + time + \" value=\" + parts[3] + \" dix=\" + dix);\n            if (parts.length == 6) {\n              var bytext = this.cvtControlledBy(Number(parts[5]));\n              this.tempData.datasets[ix].data[dix] = {\n                x: time,\n                y: value,\n                by: bytext\n              };\n            } else {\n              this.tempData.datasets[ix].data[dix] = {\n                x: time,\n                y: value,\n                by: ''\n              };\n            }\n          }\n        }\n      }\n      // Fill in the blanks\n      for (var d = 1; d <= this.devices.length; d++) {\n        var lasty = this.tempData.datasets[d].data[0].y;\n        var lastby = this.tempData.datasets[d].data[0].by;\n        for (i = 1; i < 1441; i++) {\n          if (this.tempData.datasets[d].data[i] === undefined) {\n            this.tempData.datasets[d].data[i] = {\n              x: this.starttime + i * 60000,\n              y: lasty,\n              by: lastby\n            };\n          } else {\n            lasty = this.tempData.datasets[d].data[i].y;\n            lastby = this.tempData.datasets[d].data[i].by;\n          }\n        }\n      }\n      this.loaded = true;\n    },\n    cvtControlledBy(by) {\n      if (by > 0) {\n        return 'Temp rule ' + by;\n      } else if (by == -1) {\n        return 'Sprayer rule';\n      } else if (by == -2) {\n        return 'Mist rule';\n      } else if (by == -3) {\n        return 'Timer';\n      }\n      return by;\n    },\n    getDeviceIndex(dev) {\n      var ix = -1;\n      for (var i = 0; i < this.devices.length; i++) {\n        if (dev === this.devices[i]) {\n          ix = i;\n          break;\n        }\n      }\n      return ix;\n    },\n    /*\n    params:\n      time: datetime-string e.g. \"2023-07-05T16:14:02\"\n    return:\n      datetime in milliseconds since 1/1/70, rounded to minutes\n    */\n    getMinutes(time) {\n      // \n      var t = Date.parse(time);\n      return Math.floor(t / 60000) * 60000;\n    },\n    /*\n    params:\n      timeStart: datetime in milliseconds since 1/1/70, rounded to minutes\n      thisTime:  datetime-string e.g. \"2023-07-05T16:14:02\"\n    return:\n      minutes gone by since timeStart (=0)\n    */\n    getTimeIndex(timeStart, thisTime) {\n      var tn = this.getMinutes(thisTime);\n      return (tn - timeStart) / 60000;\n    }\n  },\n  watch: {\n    day(newValue) {\n      if (newValue != '') {\n        this.getTempDataFile(newValue);\n        this.showGraph = true;\n      }\n    }\n  },\n  mounted() {\n    this.emitter.on('newtcu', tcu => {\n      console.log(\"Graphs page received 'newtcu' message: \", tcu);\n      this.tcu = tcu;\n      this.showDay = false;\n      this.showGraph = false;\n      this.getProperties();\n      this.getHistDataFiles();\n    });\n    this.showDay = false;\n    this.showGraph = false;\n  }\n};","map":{"version":3,"mappings":"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","names":["Chart","ChartJS","CategoryScale","LinearScale","PointElement","LineElement","Title","Tooltip","Legend","TimeScale","Line","register","components","name","props","data","loading","errmsg","retrieveResult","showDay","showGraph","tcu","ipaddress","devices","search","fileNames","day","loaded","starttime","stoptime","graphHeight","graphSpace","devColors","tempData","labels","datasets","label","borderColor","chartOptions","responsive","maintainAspectRatio","plugins","legend","display","tooltip","callbacks","context","dataset","parsed","y","datasetIndex","bytext","dataIndex","by","length","scales","type","ticks","callback","grid","x","time","unit","displayFormats","hour","tooltipFormat","source","min","max","elements","point","pointStyle","line","borderWidth","computed","chartHeight","height","position","methods","getProperties","axios","post","command","then","response","f","error","undefined","dev","push","device","catch","message","getHistDataFiles","nm","files","String","replace","getTempDataFile","file","cvtTempData","content","getStateDataFile","raw","lines","split","l","parts","getMinutes","temp","Number","cvtStateData","i","Array","prevdix","ix","getDeviceIndex","value","dix","getTimeIndex","console","log","cvtControlledBy","d","lasty","lastby","t","Date","parse","Math","floor","timeStart","thisTime","tn","watch","newValue","mounted","emitter","on"],"sourceRoot":"","sources":["/homes/tom/Workspaces/java/tcu-monitor/src/main/vue/src/components/Graphs.vue"],"sourcesContent":["<template>\n  <BFormGroup label-cols-sm=\"5\" label-align-sm=\"end\" label=\"Kies een dag:\" label-for=\"input-2\" content-cols-sm=\"2\" class=\"text-size\">\n    <BFormSelect id=\"input-2\" v-model=\"day\" :options=\"fileNames\" class=\"text-size\"></BFormSelect>\n  </BFormGroup>\n  <BContainer fluid v-show=\"showGraph\">\n    <BRow>\n      <BCol class=\"col-xxl-11\">\n        <Line v-if=\"loaded\" :options=\"chartOptions\" :data=\"tempData\" :style=\"chartHeight\"></Line>\n      </BCol>\n    </BRow>\n  </BContainer>\n</template>\n\n<style>\n</style>\n\n<script>\nimport 'chartjs-adapter-moment'\n\nimport {\n  Chart as ChartJS,\n  CategoryScale,\n  LinearScale,\n  PointElement,\n  LineElement,\n  Title,\n  Tooltip,\n  Legend,\n  TimeScale\n} from 'chart.js'\n\nimport { Line } from 'vue-chartjs'\n\nChartJS.register(\n  CategoryScale,\n  LinearScale,\n  PointElement,\n  LineElement,\n  Title,\n  Tooltip,\n  Legend,\n  TimeScale\n)\n\nexport default {\n  components: {\n    Line\n  },\n  name: 'HomePage',\n  props: ['showPage'],\n  data() {\n    return {\n      loading: false,\n      errmsg: '',\n      retrieveResult: '',\n      showDay: false,\n      showGraph: false,\n      tcu:{name:'',ipaddress:''},\n      devices:[],\n      search: '',\n      fileNames:[],\n      day: '',\n      loaded: false,\n      starttime: 0,\n      stoptime: 0,\n      graphHeight: 1.0,\n      graphSpace: 0.3,\n      devColors: ['#332655','#490099','#5d00d9','#6d00ff','#8557ff','#ffa79c','#055636','#699986','#9bc173','#ee9a00','#f86051','#00cc1a'],\n      tempData : {labels:[],datasets:[{label:'',borderColor:'#f87979',data:[]}]},\n      chartOptions: {responsive:true, maintainAspectRatio:false,\n        plugins: {\n          legend:{display:true},\n          tooltip: {\n            callbacks: {\n              label: function(context) {\n                let label = context.dataset.label || '';\n                if (label) {\n                    label += ': ';\n                }\n                if (context.parsed.y !== null) {\n                  if (context.datasetIndex === 0) { // Temperature\n                    label += (context.parsed.y * 20) + 15;\n                  } else {\n                    label += (((context.parsed.y) / (1.0 + 0.3)) - context.datasetIndex) > 0.0 ? 'on' : 'off' ;\n                    let bytext = context.dataset.data[context.dataIndex].by;\n                    if (bytext.length > 0) {\n                      label += ' by: ' + context.dataset.data[context.dataIndex].by;\n                    }\n                  }\n                }\n                return label;\n              }\n            }\n          },\n        },\n        scales: {\n          y: {\n            type: 'linear',\n            ticks: {\n              callback:\n                function () {\n                  return '';\n                },\n              },\n            grid: {display: false,},\n          },\n          x: {\n            type: 'time',\n            time: {\n              unit: 'hour',\n              displayFormats: {\n                  hour: 'HH:mm'\n              },\n              tooltipFormat: 'HH:mm',\n              ticks: {\n                source: 'auto',\n              },\n            },\n            min: this.starttime,\n            max: this.starttime + 1440000000,\n          },\n        },\n        elements: {\n          point: {\n            pointStyle: false,\n          },\n          line: {\n            borderWidth: 1,\n          }\n        }\n      }\n    }\n  },\n  computed: {\n    chartHeight () {return {height:`${500}px`,position: 'relative'}}\n  },\n  methods: {\n    getProperties() {\n      this.loading = true;\n      this.axios.post(\"/api/command\", {\n        command: \"getProperties\",\n        data: {ipaddress:this.tcu.ipaddress}\n      })\n      .then(response => {\n        var f = response.data;\n        if (f.error !== undefined) {\n          this.errmsg = \"danger\";\n          this.retrieveResult = f.error;\n        } else {\n          this.devices = [];\n          for (var dev of f.devices) {\n            this.devices.push(dev.device);\n          }\n        }\n        this.loading = false;\n      })\n      .catch(error => {\n        this.retrieveResult = error.message;\n        this.errmsg = \"danger\";\n        this.loading = false;\n      });\n    },\n    getHistDataFiles() {\n      this.loading = true;\n      this.axios.post(\"/api/command\", {\n        command: \"getHistDataFiles\",\n        data: {ipaddress:this.tcu.ipaddress}\n      })\n      .then(response => {\n        var f = response.data;\n        if (f.error !== undefined) {\n          this.errmsg = \"danger\";\n          this.retrieveResult = f.error;\n        } else {\n          this.fileNames = [];\n          for (var nm of f.files) {\n            this.fileNames.push(String(nm).replace(\"temp_\",\"\"));\n          }\n        }\n        this.loading = false;\n      })\n      .catch(error => {\n        this.retrieveResult = error.message;\n        this.errmsg = \"danger\";\n        this.loading = false;\n      });\n    },\n    getTempDataFile(day) {\n      this.loaded = false;\n      this.loading = true;\n      this.axios.post(\"/api/command\", {\n        command: \"getTempDataFile\",\n        data: {ipaddress:this.tcu.ipaddress, file:'temp_' + day}\n      })\n      .then(response => {\n        var f = response.data;\n        if (f.error !== undefined) {\n          this.errmsg = \"danger\";\n          this.retrieveResult = f.error;\n        } else {\n          this.errmsg = \"success\";\n          this.retrieveResult = \"\";\n          this.cvtTempData(f.content);\n          this.getStateDataFile(day);\n        }\n        this.loading = false;\n      })\n      .catch(error => {\n        this.retrieveResult = error.message;\n        this.errmsg = \"danger\";\n        this.loading = false;\n      });\n    },\n    cvtTempData(raw) {\n/*\n2023-07-05 14:00:00 start\n2023-07-05 14:00:02 r=0 t=0\n...\n2023-07-06 13:59:03 r=0 t=0\n2023-07-06 14:00:03 r=0 t=0\n2023-07-06 14:00:02 stop\n*/\n      this.tempData.datasets=[];\n      this.tempData.datasets.push({label:'Temperature',borderColor : '#f87979', data: []});\n      var lines = String(raw).split(\"\\n\");\n      for (var l of lines) {\n        var parts = String(l).split(\" \");\n        if (parts.length === 3) {\n          if (parts[2] === \"start\") {\n            this.starttime = this.getMinutes(parts[0] + \"T\" + parts[1]);\n          } else {\n            this.stoptime = this.getMinutes(parts[0] + \"T\" + parts[1]);\n          }\n        } else if (parts.length > 3) {\n          var temp =  Number(String(parts[3]).split(\"=\")[1]); // terrarium temperature\n          if (temp === 0) temp = 26.0;\n          temp = (temp - 15.0) * this.graphHeight / (35.0 - 15.0);\n          var time = this.getMinutes(parts[0] + \"T\" + parts[1]);\n          this.tempData.datasets[0].data.push({x:time, y:temp});\n        }\n      }\n    },\n    getStateDataFile(day) {\n      this.loading = true;\n      this.axios.post(\"/api/command\", {\n        command: \"getStateDataFile\",\n        data: {ipaddress:this.tcu.ipaddress, file:'state_' + day}\n      })\n      .then(response => {\n        var f = response.data;\n        if (f.error !== undefined) {\n          this.errmsg = \"danger\";\n          this.retrieveResult = f.error;\n        } else {\n          this.errmsg = \"success\";\n          this.retrieveResult = \"\";\n          this.cvtStateData(f.content);\n        }\n        this.loading = false;\n      })\n      .catch(error => {\n        this.retrieveResult = error.message;\n        this.errmsg = \"danger\";\n        this.loading = false;\n      });\n    },\n    cvtStateData(raw) {\n/*\ndate       time     device endtime controlled by (0: free, 1-5: temp rule, -1: sprayer rule, -2: mist rule, -3: timer)\n------------------------------\n2023-08-01 00:00:00 light6 1 4\n2023-08-01 00:00:00 pump 0 4\n2023-08-01 00:00:00 sprayer 0 4\n2023-08-01 00:00:00 mist 0 4\n2023-08-01 00:00:00 fan_in 0 4\n2023-08-01 00:00:00 fan_out 0 4\n2023-08-01 00:00:00 spare 0 4\n2023-08-01 06:00:02 mist 1 -1 -3\n2023-08-01 06:00:02 fan_in 0 -2\n2023-08-01 06:00:02 fan_out 0 -2\n2023-08-01 06:45:02 mist 0 0\n2023-08-01 06:45:02 fan_in 0 0\n2023-08-01 06:45:02 fan_out 0 0\n2023-08-01 09:00:02 light1 1 -1 -3\n2023-08-01 09:00:02 light6 0 0\n2023-08-01 09:30:02 light2 1 -1 -3\n2023-08-01 10:00:02 light3 1 -1 -3\n2023-08-01 10:05:02 sprayer 1 10:05:32 -3\n2023-08-01 10:05:02 fan_in 0 -1\n2023-08-01 10:05:02 fan_out 0 -1\n2023-08-01 10:05:32 sprayer 0 0\n2023-08-01 10:15:02 light4 1 -1 -3\n2023-08-01 10:20:02 fan_in 1 10:35:02 -1\n2023-08-01 10:20:02 fan_out 1 10:35:02 -1\n2023-08-01 10:35:02 fan_in 0 0\n2023-08-01 10:35:02 fan_out 0 0\n2023-08-01 10:37:02 fan_in 1 -2 5\n*/\n      this.loaded = false;\n      for (var i=1; i<=this.devices.length; i++) {\n        this.tempData.datasets.push({label: this.devices[i-1], borderColor: this.devColors[i-1], data: Array(1441)});\n      }\n      var prevdix = [0,0,0,0,0,0,0,0,0,0,0,0];\n\n      var lines = String(raw).split(\"\\n\");\n      for (var l of lines) {\n        var parts = String(l).split(\" \");\n        if (parts.length > 3) {\n          var ix = this.getDeviceIndex(parts[2]) + 1;\n          if (ix !== 0) {\n            var time = this.getMinutes(parts[0] + \"T\" + parts[1]); // in milliseconds\n            var value = (ix * (this.graphHeight + this.graphSpace)) + (Number(parts[3]) * this.graphHeight); // 0.0 => 2.0\n            var dix = this.getTimeIndex(this.starttime, parts[0] + \"T\" + parts[1]);\n            if (prevdix[ix] === dix) {\n              dix += 1; // on and off within a minute, then do the off one minute later\n            }\n            prevdix[ix] = dix;\n            console.log(\"Device=\" + parts[2] + \" time=\" + time + \" value=\" + parts[3] + \" dix=\" + dix);\n            if (parts.length == 6) {\n              var bytext = this.cvtControlledBy(Number(parts[5]));\n              this.tempData.datasets[ix].data[dix] = {x:time, y:value, by:bytext};\n            } else {\n              this.tempData.datasets[ix].data[dix] = {x:time, y:value, by:''};\n            }\n          }\n        }\n      }\n      // Fill in the blanks\n      for (var d=1; d<=this.devices.length; d++) {\n        var lasty = this.tempData.datasets[d].data[0].y;\n        var lastby = this.tempData.datasets[d].data[0].by;\n        for (i=1; i<1441; i++) {\n          if (this.tempData.datasets[d].data[i] === undefined) {\n            this.tempData.datasets[d].data[i] = {x: this.starttime + (i * 60000), y: lasty, by: lastby};\n          } else {\n            lasty = this.tempData.datasets[d].data[i].y;\n            lastby = this.tempData.datasets[d].data[i].by;\n          }\n        }\n      }\n      this.loaded = true;\n    },\n    cvtControlledBy(by) {\n      if (by > 0) {\n        return 'Temp rule ' + by;\n      } else if (by == -1) {\n        return 'Sprayer rule'\n      } else if (by == -2) {\n        return 'Mist rule'\n      } else if (by == -3) {\n        return 'Timer'\n      }\n      return by;\n    },\n    getDeviceIndex(dev) {\n      var ix = -1;\n      for (var i=0; i<this.devices.length; i++) {\n        if(dev === this.devices[i]) {\n          ix = i;\n          break;\n        }\n      }\n      return ix;\n    },\n    /*\n    params:\n      time: datetime-string e.g. \"2023-07-05T16:14:02\"\n    return:\n      datetime in milliseconds since 1/1/70, rounded to minutes\n    */\n    getMinutes(time) { // \n      var t = Date.parse(time);\n      return Math.floor(t / 60000) * 60000;\n    },\n    /*\n    params:\n      timeStart: datetime in milliseconds since 1/1/70, rounded to minutes\n      thisTime:  datetime-string e.g. \"2023-07-05T16:14:02\"\n    return:\n      minutes gone by since timeStart (=0)\n    */\n    getTimeIndex(timeStart, thisTime) {\n      var tn = this.getMinutes(thisTime);\n      return (tn - timeStart) / 60000;\n    }\n  },\n  watch: {\n    day(newValue) {\n      if (newValue != '') {\n        this.getTempDataFile(newValue);\n        this.showGraph = true;\n      }\n    }\n  },\n  mounted() {\n    this.emitter.on('newtcu', tcu => {\n        console.log(\"Graphs page received 'newtcu' message: \", tcu);\n        this.tcu = tcu;\n        this.showDay = false;\n        this.showGraph = false;\n        this.getProperties();\n        this.getHistDataFiles();\n      }\n    );\n    this.showDay = false;\n    this.showGraph = false;\n  },\n}\n</script>"]},"metadata":{},"sourceType":"module","externalDependencies":[]}