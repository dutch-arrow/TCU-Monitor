{"ast":null,"code":"import \"core-js/modules/es.array.push.js\";\nimport 'chartjs-adapter-moment';\nimport { Chart as ChartJS, CategoryScale, LinearScale, PointElement, LineElement, Title, Tooltip, Legend, TimeScale } from 'chart.js';\nimport { Line } from 'vue-chartjs';\nChartJS.register(CategoryScale, LinearScale, PointElement, LineElement, Title, Tooltip, Legend, TimeScale);\nexport default {\n  components: {\n    Line\n  },\n  name: 'HomePage',\n  props: ['showPage'],\n  data() {\n    return {\n      loading: false,\n      errmsg: '',\n      retrieveResult: '',\n      showDay: false,\n      showGraph: false,\n      config: {\n        tcu: []\n      },\n      tcus: [{\n        value: {\n          name: '',\n          ipaddress: ''\n        },\n        text: ''\n      }],\n      tcu: {\n        name: '',\n        ipaddress: ''\n      },\n      devices: [],\n      search: '',\n      fileNames: [],\n      day: '',\n      loaded: false,\n      starttime: 0,\n      stoptime: 0,\n      tempData: {\n        labels: [],\n        datasets: [{\n          label: '',\n          borderColor: '#f87979',\n          data: []\n        }]\n      },\n      chartOptions: {\n        responsive: true,\n        maintainAspectRatio: false,\n        plugins: {\n          legend: {\n            display: false\n          }\n        },\n        scales: {\n          y: {\n            ticks: {\n              callback: function () {\n                return '';\n              }\n            },\n            grid: {\n              display: false\n            },\n            min: 0.0,\n            max: 27.0\n          },\n          x: {\n            type: 'time',\n            time: {\n              unit: 'hour',\n              displayFormats: {\n                hour: 'HH:mm'\n              },\n              tooltipFormat: 'HH:mm',\n              ticks: {\n                source: 'auto'\n              }\n            },\n            min: this.starttime,\n            max: this.starttime + 1440000000\n          }\n        }\n      }\n    };\n  },\n  computed: {\n    chartHeight() {\n      return {\n        height: `${1000}px`,\n        position: 'relative'\n      };\n    }\n  },\n  methods: {\n    getTcus() {\n      console.log(\"TCUs:\", this.config.tcu);\n      this.tcus = [];\n      for (var t of this.config.tcu) {\n        this.tcus.push({\n          value: {\n            name: t.name,\n            ipaddress: t.ipaddress\n          },\n          text: t.name\n        });\n      }\n      console.log(\"List of TCUs:\", this.tcus);\n    },\n    getProperties() {\n      console.log(\"getProperties()\");\n      this.loading = true;\n      this.axios.post(\"/api/command\", {\n        command: \"getProperties\",\n        data: {\n          ipaddress: this.tcu.ipaddress\n        }\n      }).then(response => {\n        var f = response.data;\n        if (f.error !== undefined) {\n          this.errmsg = \"danger\";\n          this.retrieveResult = f.error;\n        } else {\n          this.devices = [];\n          for (var dev of f.devices) {\n            this.devices.push(dev.device);\n          }\n        }\n        console.log(\"Devices:\", this.devices);\n        this.loading = false;\n      }).catch(error => {\n        this.retrieveResult = error.message;\n        this.errmsg = \"danger\";\n        this.loading = false;\n      });\n    },\n    getHistDataFiles() {\n      console.log(\"getHistDataFiles()\");\n      this.loading = true;\n      this.axios.post(\"/api/command\", {\n        command: \"getHistDataFiles\",\n        data: {\n          ipaddress: this.tcu.ipaddress\n        }\n      }).then(response => {\n        var f = response.data;\n        if (f.error !== undefined) {\n          this.errmsg = \"danger\";\n          this.retrieveResult = f.error;\n        } else {\n          this.fileNames = [];\n          for (var nm of f.files) {\n            this.fileNames.push(String(nm).replace(\"temp_\", \"\"));\n          }\n        }\n        this.loading = false;\n      }).catch(error => {\n        this.retrieveResult = error.message;\n        this.errmsg = \"danger\";\n        this.loading = false;\n      });\n    },\n    getTempDataFile(day) {\n      console.log(\"getTempDataFile(\" + day + \")\");\n      this.loaded = false;\n      this.loading = true;\n      this.axios.post(\"/api/command\", {\n        command: \"getTempDataFile\",\n        data: {\n          ipaddress: this.tcu.ipaddress,\n          file: 'temp_' + day\n        }\n      }).then(response => {\n        var f = response.data;\n        if (f.error !== undefined) {\n          this.errmsg = \"danger\";\n          this.retrieveResult = f.error;\n        } else {\n          this.errmsg = \"success\";\n          this.retrieveResult = \"\";\n          this.cvtTempData(f.content);\n          this.getStateDataFile(day);\n        }\n        this.loading = false;\n      }).catch(error => {\n        this.retrieveResult = error.message;\n        this.errmsg = \"danger\";\n        this.loading = false;\n      });\n    },\n    cvtTempData(raw) {\n      /*\n      2023-07-05 14:00:00 start\n      2023-07-05 14:00:02 r=0 t=0\n      ...\n      2023-07-06 13:59:03 r=0 t=0\n      2023-07-06 14:00:03 r=0 t=0\n      2023-07-06 14:00:02 stop\n      */\n      this.tempData.datasets[0].data = [];\n      var lines = String(raw).split(\"\\n\");\n      for (var l of lines) {\n        var parts = String(l).split(\" \");\n        if (parts.length === 3) {\n          if (parts[2] === \"start\") {\n            this.starttime = this.getMinutes(parts[0] + \"T\" + parts[1]);\n          } else {\n            this.stoptime = this.getMinutes(parts[0] + \"T\" + parts[1]);\n          }\n        } else if (parts.length > 3) {\n          var temp = Number(String(parts[3]).split(\"=\")[1]); // terrarium temperature\n          if (temp === 0) temp = 26.0;\n          temp = (temp - 15.0) * 2.0 / (35.0 - 15.0); // scaling temp to a value between 0 and 2\n          var time = this.getMinutes(parts[0] + \"T\" + parts[1]);\n          this.tempData.datasets[0].data.push({\n            x: time,\n            y: temp\n          });\n        }\n      }\n      console.log(this.tempData);\n    },\n    getStateDataFile(day) {\n      console.log(\"getStateDataFile(\" + day + \")\");\n      this.loading = true;\n      this.axios.post(\"/api/command\", {\n        command: \"getStateDataFile\",\n        data: {\n          ipaddress: this.tcu.ipaddress,\n          file: 'state_' + day\n        }\n      }).then(response => {\n        var f = response.data;\n        if (f.error !== undefined) {\n          this.errmsg = \"danger\";\n          this.retrieveResult = f.error;\n        } else {\n          this.errmsg = \"success\";\n          this.retrieveResult = \"\";\n          this.cvtStateData(f.content);\n        }\n        this.loading = false;\n      }).catch(error => {\n        this.retrieveResult = error.message;\n        this.errmsg = \"danger\";\n        this.loading = false;\n      });\n    },\n    cvtStateData(raw) {\n      /*\n      2023-07-04 17:00:00 start\n      2023-07-04 17:00:00 light1 1\n      2023-07-04 17:00:00 light2 1\n      2023-07-04 17:00:00 light3 1\n      2023-07-04 17:00:00 light4 1\n      2023-07-04 17:00:00 uvlight 1\n      2023-07-04 17:00:00 light6 0\n      2023-07-04 17:00:00 pump 0\n      2023-07-04 17:00:00 sprayer 0\n      2023-07-04 17:00:00 mist 0\n      2023-07-04 17:00:00 fan_in 1\n      2023-07-04 17:00:00 fan_out 0\n      2023-07-04 17:00:00 spare 0\n      2023-07-04 20:00:02 pump 1 -1\n      2023-07-04 20:05:02 fan_out 1 -1\n      2023-07-04 20:15:02 pump 0\n      2023-07-04 20:15:02 fan_in 0\n      2023-07-04 20:15:02 fan_out 0\n      2023-07-04 20:15:02 fan_in 1 -2\n      2023-07-05 10:05:02 sprayer 1 10:05:32\n      2023-07-06 14:00:02 stop\n      */\n      var graphHeight = 2.0;\n      var graphSpace = 0.5;\n      this.loaded = false;\n      for (var i = 1; i <= this.devices.length; i++) {\n        this.tempData.datasets.push({\n          data: Array(1441)\n        });\n      }\n      var lines = String(raw).split(\"\\n\");\n      for (var l of lines) {\n        var parts = String(l).split(\" \");\n        if (parts.length > 3) {\n          var ix = this.getDeviceIndex(parts[2]) + 1;\n          if (ix !== 0) {\n            var time = this.getMinutes(parts[0] + \"T\" + parts[1]); // in milliseconds\n            var value = ix * (graphHeight + graphSpace) + Number(parts[3]) * graphHeight; // 0.0 => 2.0\n            var dix = this.getTimeIndex(this.starttime, parts[0] + \"T\" + parts[1]);\n            this.tempData.datasets[ix].data[dix] = {\n              x: time,\n              y: value\n            };\n          }\n        }\n      }\n      // Fill in the blanks\n      for (var d = 1; d <= this.devices.length; d++) {\n        var lasty = this.tempData.datasets[d].data[0].y;\n        for (i = 1; i < 1441; i++) {\n          if (this.tempData.datasets[d].data[i] === undefined) {\n            this.tempData.datasets[d].data[i] = {\n              x: this.starttime + i * 60000,\n              y: lasty\n            };\n          } else {\n            lasty = this.tempData.datasets[d].data[i].y;\n          }\n        }\n      }\n      console.log(this.tempData);\n      this.loaded = true;\n    },\n    getDeviceIndex(dev) {\n      var ix = -1;\n      for (var i = 0; i < this.devices.length; i++) {\n        if (dev === this.devices[i]) {\n          ix = i;\n          break;\n        }\n      }\n      return ix;\n    },\n    /*\n    params:\n      time: datetime-string e.g. \"2023-07-05T16:14:02\"\n    return:\n      datetime in milliseconds since 1/1/70, rounded to minutes\n    */\n    getMinutes(time) {\n      // \n      var t = Date.parse(time);\n      return Math.floor(t / 60000) * 60000;\n    },\n    /*\n    params:\n      timeStart: datetime in milliseconds since 1/1/70, rounded to minutes\n      thisTime:  datetime-string e.g. \"2023-07-05T16:14:02\"\n    return:\n      minutes gone by since timeStart (=0)\n    */\n    getTimeIndex(timeStart, thisTime) {\n      var tn = this.getMinutes(thisTime);\n      return (tn - timeStart) / 60000;\n    }\n  },\n  watch: {\n    tcu(newValue) {\n      console.log(\"Variable 'tcu' has changed to \" + newValue);\n      if (newValue != undefined) {\n        this.day = '';\n        this.getHistDataFiles(newValue);\n        this.getProperties();\n        this.showDay = true;\n      }\n    },\n    day(newValue) {\n      console.log(\"Variable 'day' has changed to \" + newValue);\n      if (newValue != '') {\n        this.getTempDataFile(newValue);\n        this.showGraph = true;\n      }\n    }\n  },\n  mounted() {\n    this.emitter.on('config', cfg => {\n      console.log(\"Home page received 'config' message: \", cfg);\n      this.config = cfg;\n      this.showDay = false;\n      this.showGraph = false;\n      this.getTcus();\n    });\n    //    this.getTcus();\n    this.showDay = false;\n    this.showGraph = false;\n  }\n};","map":{"version":3,"mappings":"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","names":["Chart","ChartJS","CategoryScale","LinearScale","PointElement","LineElement","Title","Tooltip","Legend","TimeScale","Line","register","components","name","props","data","loading","errmsg","retrieveResult","showDay","showGraph","config","tcu","tcus","value","ipaddress","text","devices","search","fileNames","day","loaded","starttime","stoptime","tempData","labels","datasets","label","borderColor","chartOptions","responsive","maintainAspectRatio","plugins","legend","display","scales","y","ticks","callback","grid","min","max","x","type","time","unit","displayFormats","hour","tooltipFormat","source","computed","chartHeight","height","position","methods","getTcus","console","log","t","push","getProperties","axios","post","command","then","response","f","error","undefined","dev","device","catch","message","getHistDataFiles","nm","files","String","replace","getTempDataFile","file","cvtTempData","content","getStateDataFile","raw","lines","split","l","parts","length","getMinutes","temp","Number","cvtStateData","graphHeight","graphSpace","i","Array","ix","getDeviceIndex","dix","getTimeIndex","d","lasty","Date","parse","Math","floor","timeStart","thisTime","tn","watch","newValue","mounted","emitter","on","cfg"],"sourceRoot":"","sources":["/homes/tom/Workspaces/java/tcu-monitor/src/main/vue/src/components/Home.vue"],"sourcesContent":["<template>\n    <BCard title=\"Home Page\" v-show=\"showPage\">\n      <BAlert :model-value=\"retrieveResult !== ''\" :variant=\"errmsg\" show>{{ retrieveResult }}</BAlert>\n      <BOverlay :show=\"loading\" variant=\"light\" opacity=\"0.6\" rounded=\"sm\"></BOverlay>\n      <BCard notitle>\n        <BFormGroup label-cols-sm=\"5\" label-align-sm=\"end\" label=\"Kies de TCU:\" label-for=\"input-1\" content-cols-sm=\"2\" class=\"text-size\">\n          <BFormSelect id=\"input-1\" v-model=\"tcu\" :options=\"tcus\" class=\"text-size\"></BFormSelect>\n        </BFormGroup>\n        <div v-show=\"showDay\">\n          <BFormGroup label-cols-sm=\"5\" label-align-sm=\"end\" label=\"Kies een dag:\" label-for=\"input-2\" content-cols-sm=\"2\" class=\"text-size\">\n            <BFormSelect id=\"input-2\" v-model=\"day\" :options=\"fileNames\" class=\"text-size\"></BFormSelect>\n          </BFormGroup>\n        </div>\n      </BCard>\n      <BContainer fluid v-show=\"showGraph\">\n        <BRow>\n          <BCol class=\"col-xxl-1\" style=\"display:flex;\">\n            <div class=\"graph-label\">Temperature</div>\n          </BCol>\n         <BCol class=\"col-xxl-11\">\n            <Line v-if=\"loaded\" :options=\"chartOptions\" :data=\"tempData\" :style=\"chartHeight\"></Line>\n          </BCol>\n        </BRow>\n      </BContainer>\n    </BCard>\n</template>\n\n<style>\n.graph-label {\n  font-size: 14px;\n  align-self: center;\n }\n</style>\n<script>\nimport 'chartjs-adapter-moment'\n\nimport {\n  Chart as ChartJS,\n  CategoryScale,\n  LinearScale,\n  PointElement,\n  LineElement,\n  Title,\n  Tooltip,\n  Legend,\n  TimeScale\n} from 'chart.js'\n\nimport { Line } from 'vue-chartjs'\n\nChartJS.register(\n  CategoryScale,\n  LinearScale,\n  PointElement,\n  LineElement,\n  Title,\n  Tooltip,\n  Legend,\n  TimeScale\n)\n\nexport default {\n  components: {\n    Line\n  },\n  name: 'HomePage',\n  props: ['showPage'],\n  data() {\n    return {\n      loading: false,\n      errmsg: '',\n      retrieveResult: '',\n      showDay: false,\n      showGraph: false,\n      config:{tcu:[]},\n      tcus:[{value:{name:'',ipaddress:''},text:''}],\n      tcu:{name:'',ipaddress:''},\n      devices:[],\n      search: '',\n      fileNames:[],\n      day: '',\n      loaded: false,\n      starttime: 0,\n      stoptime: 0,\n      tempData : {labels:[],datasets:[{label:'',borderColor:'#f87979',data:[]}]},\n      chartOptions: {responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}},\n        scales: {\n          y: {\n            ticks: {callback: function () {return '';},},\n            grid: {display: false,},\n            min: 0.0,\n            max: 27.0,\n          },\n          x: {\n            type: 'time',\n            time: {\n              unit: 'hour',\n              displayFormats: {\n                  hour: 'HH:mm'\n              },\n              tooltipFormat: 'HH:mm',\n              ticks: {\n                source: 'auto',\n              },\n            },\n            min: this.starttime,\n            max: this.starttime + 1440000000,\n          },\n        },\n      }\n    }\n  },\n  computed: {\n    chartHeight () {return {height:`${1000}px`,position: 'relative'}}\n  },\n  methods: {\n    getTcus() {\n      console.log(\"TCUs:\", this.config.tcu);\n      this.tcus = [];\n      for (var t of this.config.tcu) {\n        this.tcus.push({value:{name:t.name,ipaddress:t.ipaddress},text:t.name});\n      }\n      console.log(\"List of TCUs:\", this.tcus);\n    },\n    getProperties() {\n      console.log(\"getProperties()\");\n      this.loading = true;\n      this.axios.post(\"/api/command\", {\n        command: \"getProperties\",\n        data: {ipaddress:this.tcu.ipaddress}\n      })\n      .then(response => {\n        var f = response.data;\n        if (f.error !== undefined) {\n          this.errmsg = \"danger\";\n          this.retrieveResult = f.error;\n        } else {\n          this.devices = [];\n          for (var dev of f.devices) {\n            this.devices.push(dev.device);\n          }\n        }\n        console.log(\"Devices:\", this.devices);\n        this.loading = false;\n      })\n      .catch(error => {\n        this.retrieveResult = error.message;\n        this.errmsg = \"danger\";\n        this.loading = false;\n      });\n    },\n    getHistDataFiles() {\n      console.log(\"getHistDataFiles()\");\n      this.loading = true;\n      this.axios.post(\"/api/command\", {\n        command: \"getHistDataFiles\",\n        data: {ipaddress:this.tcu.ipaddress}\n      })\n      .then(response => {\n        var f = response.data;\n        if (f.error !== undefined) {\n          this.errmsg = \"danger\";\n          this.retrieveResult = f.error;\n        } else {\n          this.fileNames = [];\n          for (var nm of f.files) {\n            this.fileNames.push(String(nm).replace(\"temp_\",\"\"));\n          }\n        }\n        this.loading = false;\n      })\n      .catch(error => {\n        this.retrieveResult = error.message;\n        this.errmsg = \"danger\";\n        this.loading = false;\n      });\n    },\n    getTempDataFile(day) {\n      console.log(\"getTempDataFile(\" +  day + \")\");\n      this.loaded = false;\n      this.loading = true;\n      this.axios.post(\"/api/command\", {\n        command: \"getTempDataFile\",\n        data: {ipaddress:this.tcu.ipaddress, file:'temp_' + day}\n      })\n      .then(response => {\n        var f = response.data;\n        if (f.error !== undefined) {\n          this.errmsg = \"danger\";\n          this.retrieveResult = f.error;\n        } else {\n          this.errmsg = \"success\";\n          this.retrieveResult = \"\";\n          this.cvtTempData(f.content);\n          this.getStateDataFile(day);\n        }\n        this.loading = false;\n      })\n      .catch(error => {\n        this.retrieveResult = error.message;\n        this.errmsg = \"danger\";\n        this.loading = false;\n      });\n    },\n    cvtTempData(raw) {\n/*\n2023-07-05 14:00:00 start\n2023-07-05 14:00:02 r=0 t=0\n...\n2023-07-06 13:59:03 r=0 t=0\n2023-07-06 14:00:03 r=0 t=0\n2023-07-06 14:00:02 stop\n*/\n      this.tempData.datasets[0].data = [];\n      var lines = String(raw).split(\"\\n\");\n      for (var l of lines) {\n        var parts = String(l).split(\" \");\n        if (parts.length === 3) {\n          if (parts[2] === \"start\") {\n            this.starttime = this.getMinutes(parts[0] + \"T\" + parts[1]);\n          } else {\n            this.stoptime = this.getMinutes(parts[0] + \"T\" + parts[1]);\n          }\n        } else if (parts.length > 3) {\n          var temp =  Number(String(parts[3]).split(\"=\")[1]); // terrarium temperature\n          if (temp === 0) temp = 26.0;\n          temp = (temp - 15.0) * 2.0 / (35.0 - 15.0); // scaling temp to a value between 0 and 2\n          var time = this.getMinutes(parts[0] + \"T\" + parts[1]);\n          this.tempData.datasets[0].data.push({x:time, y:temp});\n        }\n      }\n      console.log(this.tempData);\n    },\n    getStateDataFile(day) {\n      console.log(\"getStateDataFile(\" +  day + \")\");\n      this.loading = true;\n      this.axios.post(\"/api/command\", {\n        command: \"getStateDataFile\",\n        data: {ipaddress:this.tcu.ipaddress, file:'state_' + day}\n      })\n      .then(response => {\n        var f = response.data;\n        if (f.error !== undefined) {\n          this.errmsg = \"danger\";\n          this.retrieveResult = f.error;\n        } else {\n          this.errmsg = \"success\";\n          this.retrieveResult = \"\";\n          this.cvtStateData(f.content);\n        }\n        this.loading = false;\n      })\n      .catch(error => {\n        this.retrieveResult = error.message;\n        this.errmsg = \"danger\";\n        this.loading = false;\n      });\n    },\n    cvtStateData(raw) {\n/*\n2023-07-04 17:00:00 start\n2023-07-04 17:00:00 light1 1\n2023-07-04 17:00:00 light2 1\n2023-07-04 17:00:00 light3 1\n2023-07-04 17:00:00 light4 1\n2023-07-04 17:00:00 uvlight 1\n2023-07-04 17:00:00 light6 0\n2023-07-04 17:00:00 pump 0\n2023-07-04 17:00:00 sprayer 0\n2023-07-04 17:00:00 mist 0\n2023-07-04 17:00:00 fan_in 1\n2023-07-04 17:00:00 fan_out 0\n2023-07-04 17:00:00 spare 0\n2023-07-04 20:00:02 pump 1 -1\n2023-07-04 20:05:02 fan_out 1 -1\n2023-07-04 20:15:02 pump 0\n2023-07-04 20:15:02 fan_in 0\n2023-07-04 20:15:02 fan_out 0\n2023-07-04 20:15:02 fan_in 1 -2\n2023-07-05 10:05:02 sprayer 1 10:05:32\n2023-07-06 14:00:02 stop\n*/\n      var graphHeight = 2.0;\n      var graphSpace = 0.5;\n      this.loaded = false;\n      for (var i=1; i<=this.devices.length; i++) {\n        this.tempData.datasets.push({data: Array(1441)});\n      }\n      var lines = String(raw).split(\"\\n\");\n      for (var l of lines) {\n        var parts = String(l).split(\" \");\n        if (parts.length > 3) {\n          var ix = this.getDeviceIndex(parts[2]) + 1;\n          if (ix !== 0) {\n            var time = this.getMinutes(parts[0] + \"T\" + parts[1]); // in milliseconds\n            var value = (ix * (graphHeight + graphSpace)) + (Number(parts[3]) * graphHeight); // 0.0 => 2.0\n            var dix = this.getTimeIndex(this.starttime, parts[0] + \"T\" + parts[1]);\n            this.tempData.datasets[ix].data[dix] = {x:time, y:value};\n          }\n        }\n      }\n      // Fill in the blanks\n      for (var d=1; d<=this.devices.length; d++) {\n        var lasty = this.tempData.datasets[d].data[0].y;\n        for (i=1; i<1441; i++) {\n          if (this.tempData.datasets[d].data[i] === undefined) {\n            this.tempData.datasets[d].data[i] = {x: this.starttime + (i * 60000), y: lasty};\n          } else {\n            lasty = this.tempData.datasets[d].data[i].y;\n          }\n        }\n      }\n      console.log(this.tempData);\n      this.loaded = true;\n    },\n    getDeviceIndex(dev) {\n      var ix = -1;\n      for (var i=0; i<this.devices.length; i++) {\n        if(dev === this.devices[i]) {\n          ix = i;\n          break;\n        }\n      }\n      return ix;\n    },\n    /*\n    params:\n      time: datetime-string e.g. \"2023-07-05T16:14:02\"\n    return:\n      datetime in milliseconds since 1/1/70, rounded to minutes\n    */\n    getMinutes(time) { // \n      var t = Date.parse(time);\n      return Math.floor(t / 60000) * 60000;\n    },\n    /*\n    params:\n      timeStart: datetime in milliseconds since 1/1/70, rounded to minutes\n      thisTime:  datetime-string e.g. \"2023-07-05T16:14:02\"\n    return:\n      minutes gone by since timeStart (=0)\n    */\n    getTimeIndex(timeStart, thisTime) {\n      var tn = this.getMinutes(thisTime);\n      return (tn - timeStart) / 60000;\n    }\n  },\n  watch: {\n    tcu(newValue) {\n      console.log(\"Variable 'tcu' has changed to \" +  newValue);\n      if (newValue != undefined) {\n        this.day = '';\n        this.getHistDataFiles(newValue);\n        this.getProperties();\n        this.showDay = true;\n      }\n    },\n    day(newValue) {\n      console.log(\"Variable 'day' has changed to \" +  newValue);\n      if (newValue != '') {\n        this.getTempDataFile(newValue);\n        this.showGraph = true;\n      }\n    }\n  },\n  mounted() {\n    this.emitter.on('config', cfg => {\n        console.log(\"Home page received 'config' message: \", cfg);\n        this.config = cfg;\n        this.showDay = false;\n        this.showGraph = false;\n        this.getTcus();\n      }\n    );\n//    this.getTcus();\n    this.showDay = false;\n    this.showGraph = false;\n  },\n}\n</script>\n"]},"metadata":{},"sourceType":"module","externalDependencies":[]}